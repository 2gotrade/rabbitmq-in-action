## 队列优先级支持

RabbitMQ在版本3.5.0的核心中具有队列优先级的实现。

您可以使用x-max-priority参数声明队列优先级 。该参数应该是一个整数，表示队列应该支持的最大优先级。例如，使用Java客户机：

	Channel ch = ...;
	Map<String, Object> args = new HashMap<String, Object>();
	args.put("x-max-priority", 10);
	ch.queueDeclare("my-priority-queue", true, false, false, args);

然后，您可以使用basic.properties的优先级字段设置消息优先级 。较大的数字表明优先级较高。 

因为优先级队列的磁盘格式不同，所以队列优先级只能由参数而不能由策略定义。队列永远不会改变他们支持的优先级。	

## 行为

AMQP 0-9-1规范对优先级的工作原理有些含糊。它表示所有队列必须支持至少2个优先级，并且可以支持最多10个。它没有定义如何处理没有优先级属性的消息。

与AMQP 0-9-1规范相反，默认情况下，RabbitMQ队列不支持优先级。创建优先级队列时，您可以根据需要指定任意多个优先级。注意：

每个队列的优先级除了需要消耗内存和磁盘外，还需要消耗CPU，特别是在消费时，所以您可能不希望创建大量的级别。
消息优先级字段被定义为无符号字节，因此实际上优先级应在0到255之间。
没有优先级属性的消息将被视为优先级为0.优先级高于队列最大值的消息将被视为以最高优先级发布。

## 资源使用注意事项

如果需要优先级队列，我们​​建议使用1到10之间。目前使用更多的优先级将消耗更多的资源（Erlang进程）

## 与消费者的互相影响

了解消费者在使用优先级队列时如何工作很重要。默认情况下，消费者在确认任何信息之前可能会发送大量消息，仅受网络背压限制。

因此，如果这样一个饥饿的消费者连接到随后发布消息的空队列，消息可能不会花费任何时间等待在队列中。在这种情况下，优先级队列将无法获得优先级排序。

在大多数情况下，您将希望 在消费者手动确认模式下使用basic.qos方法，以限制可随时发货的邮件数量，从而允许优先处理消息。

## 与其他功能的互相影响

一般来说，优先级队列具有标准RabbitMQ队列的所有功能：它们支持持久性，分页，镜像等。有几个互相影响的地方应该注意：

应该过期的消息仍然会从队列的头部过期。这意味着与正常队列不同，即使每个队列TTL也可能导致过期的低优先级消息被卡在未过期的较高优先级消息之后。这些消息将永远不会传递，但它们将显示在队列统计信息中。

具有最大长度集的队列将像往常一样将从队列头部删除消息来强制执行限制。这意味着较高优先级的消息可能会被丢弃，以使较低优先级的消息成为较低优先级的消息，这可能不是您期望的。




	
	
	
	
	